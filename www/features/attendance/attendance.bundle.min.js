angular.module('starter').controller('AttendanceController',function(Dialog,Loader,Application,$ionicPopup,Location,$filter,Customer,GoogleMaps,$rootScope,SB,Attendance,$scope,$state,$stateParams,$translate,$interval,$timeout,$ionicModal,$cordovaBarcodeScanner){$scope.value_id=Attendance.value_id=$stateParams.value_id;$scope.is_logged_in=Customer.isLoggedIn();$scope.customer=Customer.customer;$scope.is_loading=!1;$scope.is_checked_in=!0;$scope.page_title='';$scope.current_time='';$scope.timeinterval=null;$scope.settings={};$scope.postValues={};$scope.payout_data={};$scope.current_year=null;$scope.action={tab:'attendance'};$scope.checkedClock={hours:'00',minutes:'00',seconds:'00',};$rootScope.$on(SB.EVENTS.AUTH.loginSuccess,function(){if($scope.value_id){$scope.loadContent()}
$scope.is_logged_in=Customer.isLoggedIn();$scope.customer=Customer.customer});$rootScope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){if($scope.value_id){$scope.loadContent()}
$scope.loadContent();$scope.is_logged_in=Customer.isLoggedIn();$scope.customer=Customer.customer});$scope.login=function(){Customer.loginModal($scope)}
function getTimeRemaining(startdate){var t=Date.parse(new Date())-Date.parse(startdate);var seconds=Math.floor((t/1000)%60);var minutes=Math.floor((t/1000/60)%60);var hours=Math.floor((t/(1000*60*60)));return{'total':t,'hours':hours,'minutes':minutes,'seconds':seconds}}
function initializeClock(startdate){$scope.timeinterval=$interval(function(){var t=getTimeRemaining(startdate);$scope.checkedClock.hours=('0'+t.hours).slice(-2);$scope.checkedClock.minutes=('0'+t.minutes).slice(-2);$scope.checkedClock.seconds=('0'+t.seconds).slice(-2)},1000)}
$scope.getLocation=function(){if(Location.isEnabled){Location.getLocation({timeout:10000},!0).then(function(position){$scope.postValues.latitude=position.coords.latitude;$scope.postValues.longitude=position.coords.longitude;$scope.loadContent()},function(){$scope.postValues.latitude=0;$scope.postValues.longitude=0;$scope.requestLocation()})}else{$scope.postValues.latitude=0;$scope.postValues.longitude=0;$scope.requestLocation();$scope.loadContent()}}
$scope.requestLocation=function(){Location.requestLocation(function(){$scope.loadContent()})}
$scope.loadContent=function(){if(!Customer.isLoggedIn()){return!1}
$scope.is_loading=!0;var currentDateTime=new Date();$scope.postValues.currentDateTime=currentDateTime;Attendance.findAll($scope.postValues).success(function(data){$scope.page_title=data.page_title;$scope.payout_data=data;$scope.is_checked_in=data.is_checked_in;Attendance.setSettings(data.settings);$scope.settings=data.settings;$timeout(function(){if($scope.is_checked_in){if(angular.isDefined(data.timetracking.tracking_id)){$scope.tracking_id=data.timetracking.tracking_id;$scope.postValues.startdate=data.timetracking.startdate;initializeClock(moment(data.timetracking.startdate))}}else{$scope.currentTime()}},300)}).error(function(){$scope.is_loading=!1}).finally(function(){$scope.is_loading=!1})}
$scope.customer_avatar=function(image){if(image!=''&&image!=null&&image!="null"){return IMAGE_URL+'images/customer'+image}else{return"./features/attendance/assets/media/customer-placeholder.png"}};$scope.currentTime=function(){$scope.timeinterval=$interval(function(){var today=new Date();var hours=today.getHours()<10?'0'+today.getHours():today.getHours();var minutes=today.getMinutes()<10?'0'+today.getMinutes():today.getMinutes();var seconds=today.getSeconds()<10?'0'+today.getSeconds():today.getSeconds();$scope.current_time=hours+":"+minutes+":"+seconds},1000)}
$scope.currentDate=function(){var today=new Date();var dd=today.getDate();var mm=today.getMonth();var yyyy=today.getFullYear();if(dd<10){dd="0"+dd}
var weekday=new Array(7);weekday[0]=$translate.instant("Sun","attendance");weekday[1]=$translate.instant("Mon","attendance");weekday[2]=$translate.instant("Tue","attendance");weekday[3]=$translate.instant("Wed","attendance");weekday[4]=$translate.instant("Thu","attendance");weekday[5]=$translate.instant("Fri","attendance");weekday[6]=$translate.instant("Sat","attendance");var days=weekday[today.getDay()];var months=[$translate.instant("Jan","attendance"),$translate.instant("Feb","attendance"),$translate.instant("Mar","attendance"),$translate.instant("Apr","attendance"),$translate.instant("May","attendance"),$translate.instant("Jun","attendance"),$translate.instant("Jul","attendance"),$translate.instant("Aug","attendance"),$translate.instant("Sep","attendance"),$translate.instant("Oct","attendance"),$translate.instant("Nov","attendance"),$translate.instant("Dec","attendance")];return days+', '+dd+' '+months[mm]+' '+yyyy};$scope.getMonthFullName=function(mm){var months=[$translate.instant("January","attendance"),$translate.instant("February","attendance"),$translate.instant("March","attendance"),$translate.instant("April","attendance"),$translate.instant("May","attendance"),$translate.instant("June","attendance"),$translate.instant("July","attendance"),$translate.instant("August","attendance"),$translate.instant("September","attendance"),$translate.instant("October","attendance"),$translate.instant("November","attendance"),$translate.instant("December","attendance")];return months[mm]}
$scope.leaveDeails=function(leave_deatil){$scope.is_loading=!0;$scope.all_leaves=[];$ionicModal.fromTemplateUrl('features/attendance/assets/templates/l1/modal/leave_details.html',{scope:$scope,animation:'slide-in-right-left'}).then(function(modal){Attendance.findLeavesById(leave_deatil.id).then(function(data){$scope.all_leaves=data.collections;$scope.is_loading=!1},function(error){$scope.is_loading=!1;Dialog.alert($translate.instant("Error","attendance"),error.message,$translate.instant("OK","attendance"),-1)});$scope.leave_deatil=leave_deatil;console.log($scope.leave_deatil);$scope.LeaveDetailsModal=modal;$scope.LeaveDetailsModal.show()})};$scope.cancelLeave=function(id){Loader.show();Attendance.cancelLeaveById(id).then(function(data){$scope.all_leaves=data.collections;Loader.hide()},function(error){Loader.hide();Dialog.alert($translate.instant("Error","attendance"),error.message,$translate.instant("OK","attendance"),-1)})};$scope.closeLeaveDetails=function(){$scope.LeaveDetailsModal.remove()}
$scope.applyLeave=function(){$ionicModal.fromTemplateUrl('features/attendance/assets/templates/l1/modal/apply_leave.html',{scope:$scope,animation:'slide-in-right-left'}).then(function(modal){$scope.apply_post={remaining_leave_value:0};$scope.applyLeaveModal=modal;$scope.applyLeaveModal.show()})};$scope.closeApplyLeaveDetails=function(){$scope.applyLeaveModal.remove()}
$scope.attendanceHistory=function(){$scope.is_loading=!0;var today=new Date();$scope.current_year=today.getFullYear();$scope.attendance_history={month:today.getMonth(),year:today.getFullYear(),history:{}}
$ionicModal.fromTemplateUrl('features/attendance/assets/templates/l1/modal/history.html',{scope:$scope,animation:'slide-in-right-left'}).then(function(modal){Attendance.attendanceHistory($scope.attendance_history.month,$scope.attendance_history.year).then(function(data){$scope.is_loading=!1;$scope.attendance_history.history=data.collection;$scope.total_month_time=data.total_month_time},function(error){$scope.is_loading=!1;Dialog.alert($translate.instant("Error","attendance"),error.message,$translate.instant("OK","attendance"),-1)}).then(function(){$scope.is_loading=!1});$scope.attendanceHistoryModal=modal;$scope.attendanceHistoryModal.show()})};$scope.closeAttendanceHistoryModal=function(){$scope.attendanceHistoryModal.remove()}
$scope.dialogMessages=function(message){Dialog.alert($translate.instant("Note","attendance"),message,$translate.instant("OK","attendance"))}
$scope.attendanceHistoryFilter=function(){$ionicModal.fromTemplateUrl('features/attendance/assets/templates/l1/modal/history_filter.html',{scope:$scope,animation:'slide-in-right-left'}).then(function(modal){$scope.attendanceHistoryFilterModal=modal;$scope.attendanceHistoryFilterModal.show()})};$scope.attendanceHistoryFilterSubmit=function(){Loader.show();Attendance.attendanceHistory($scope.attendance_history.month,$scope.attendance_history.year).then(function(data){Loader.hide();$scope.attendance_history.history=data.collection;$scope.total_month_time=data.total_month_time;$scope.closeAttendanceHistoryFilterModal()},function(error){Loader.hide();Dialog.alert($translate.instant("Error","attendance"),error.message,$translate.instant("OK","attendance"),-1)}).then(function(){Loader.hide()})}
$scope.closeAttendanceHistoryFilterModal=function(){$scope.attendanceHistoryFilterModal.remove()}
$scope.$on("$ionicView.leave",function(event,data){if(angular.isDefined($scope.timeinterval)){$interval.cancel($scope.timeinterval)}});$scope.$on("$ionicView.beforeEnter",function(event,data){$scope.getLocation()});$scope.StartFunctionTracking=function(){$scope.postValues.startdate=new Date();Loader.show();Attendance.saveStartContent($scope.postValues).then(function(data){if(data.is_checkout_enable==1){$scope.tracking_id=data.tracking_id;$scope.is_checked_in=!0;$scope.payout_data.timetracking=data.timetracking;initializeClock($scope.postValues.startdate)}else{Dialog.alert($translate.instant("Success","attendance"),$translate.instant("Check In successfully!","attendance"),$translate.instant("OK","attendance"),-1)}},function(error){Loader.hide();Dialog.alert($translate.instant("Error","attendance"),error.message,$translate.instant("OK","attendance"),-1)}).then(function(){Loader.hide()})}
$scope.StartTracking=function(){if($scope.payout_data.settings.project_tracking_enable&&$scope.payout_data.projects.length>0){$ionicModal.fromTemplateUrl('features/attendance/assets/templates/l1/modal/projects.html',{scope:$scope,animation:'slide-in-right-left'}).then(function(modal){$scope.projectsModal=modal;$scope.projectsModal.show()})}else{$scope.postValues.project_id=0;$scope.postValues.location_id=0;$scope.StartFunctionTracking()}}
$scope.closeProjectsModal=function(){$scope.projectsModal.remove()}
$scope.projectTrackingTracking=function(project_id){$scope.postValues.project_id=project_id;$scope.postValues.location_id=0;$ionicPopup.show({title:$translate.instant('Confirm',"attendance"),template:$translate.instant('Are you sure want to check In?',"attendance"),cssClass:'project-list',scope:$scope,buttons:[{text:$translate.instant('Cancel',"attendance"),type:'button-default',onTap:function(e){return!1}},{text:$translate.instant('OK',"attendance"),type:'button-positive',onTap:function(e){return!0}}]}).then(function(result){if(result){$scope.StartFunctionTracking();$scope.closeProjectsModal()}})}
$scope.showScanCamera=function(){if(!Application.is_webview){$cordovaBarcodeScanner.scan().then(function(barcodeData){if(barcodeData.text!==''){$timeout(function(){var qrCode=barcodeData.text.replace('sendback:','');if(qrCode>0){$scope.postValues.location_id=qrCode;$ionicModal.fromTemplateUrl('features/attendance/assets/templates/l1/modal/note.html',{scope:$scope,animation:'slide-in-right-left'}).then(function(modal){$scope.scanCheckInModal=modal;$scope.scanCheckInModal.show()})}else{Dialog.alert($translate.instant("Error","attendance"),$translate.instant('Invalid code.',"attendance"),$translate.instant('OK',"attendance"),-1)}})}else{Dialog.alert($translate.instant("Error","attendance"),$translate.instant("Unreadable QRCode, sorry","attendance"),$translate.instant('OK',"attendance"),-1,"attendance")}},function(error){Dialog.alert($translate.instant("Error","attendance"),'An error occurred while reading the code.',$translate.instant('OK',"attendance"),-1)})}else{Dialog.alert($translate.instant("Info","attendance"),$translate.instant("This will open the code scan camera on your device","attendance"),$translate.instant("Ok","attendance"),-1)}};$scope.closeScanCheckInModal=function(){$scope.scanCheckInModal.remove()}
$scope.scanCheckInSubmit=function(){$scope.postValues.project_id=0;$scope.StartFunctionTracking();$scope.closeScanCheckInModal()}
$scope.StopTracking=function(){$scope.postValues.enddate=new Date();$scope.postValues.tracking_id=$scope.tracking_id;$scope.postValues.tracking_time=$scope.checkedClock.hours+':'+$scope.checkedClock.minutes+':'+$scope.checkedClock.seconds;Loader.show();Attendance.saveEndContent($scope.postValues).then(function(data){$scope.is_checked_in=!1;if(angular.isDefined($scope.timeinterval)){$interval.cancel($scope.timeinterval)}
$timeout(function(){$scope.currentTime();$scope.checkedClock.hours='00';$scope.checkedClock.minutes='00';$scope.checkedClock.seconds='00';Loader.hide()},300)},function(error){Loader.hide();Dialog.alert($translate.instant("Error","attendance"),error.message,$translate.instant("OK","attendance"),-1)}).then(function(){Loader.hide()})}
$scope.leaveSubmit=function(){Loader.show();Attendance.leaveSubmit($scope.apply_post).then(function(data){Dialog.alert($translate.instant("Success","attendance"),data.message,$translate.instant("OK","attendance"),-1);$scope.closeApplyLeaveDetails();Loader.hide()},function(error){Loader.hide();Dialog.alert($translate.instant("Error","attendance"),error.message,$translate.instant("OK","attendance"),-1)}).then(function(){Loader.hide()})}
$scope.selectLeaveType=function(){var leavetype_value=$filter('filter')($scope.payout_data.leavetype,{id:$scope.apply_post.leavetype});$scope.apply_post.remaining_leave_value=leavetype_value[0].remaining;$scope.remaining_message_warning=$translate.instant("Remaining","attendance")+' '+leavetype_value[0].name+' is '+leavetype_value[0].remaining}
$scope.range=function(min,max,step){step=step||1;var input=[];for(var i=min;i<=max;i+=step)input.push(i);return input}}).controller('AttendanceMessageController',function($controller,Attendance,$state,$ionicScrollDelegate,$ionicActionSheet,$timeout,$ionicSlideBoxDelegate,$stateParams,$scope,$rootScope,$translate,Customer,Loader,Dialog,$filter,$ionicModal){$scope.value_id=Attendance.value_id=$stateParams.value_id;$scope.is_logged_in=Customer.isLoggedIn();$scope.customer_id=Customer.id;$scope.is_loading=!1;$scope.messages=[];$scope.sentmessages=[];$scope.convertMessageDate=function(date){return $filter("moment_calendar")((new Date(date)).getTime())};$scope._scrollBottom=function(){$timeout(function(){$ionicScrollDelegate.$getByHandle('messageScroll').scrollBottom(!0)},500)};$scope.sendMessage=function(sentmessages){if(!Customer.isLoggedIn()){return Customer.loginModal($scope)}
if(sentmessages.message==''){Dialog.alert("Validation Error","Please enter a messages!","OK",-1,"attendance")}else{$scope.sending_message=!0;Attendance.saveMessage(sentmessages).success(function(data){$scope.messages=data.messages;$scope._scrollBottom();$scope.sentmessages.message='';$scope.sending_message=!1}).error(function(error){Dialog.alert($translate.instant("Error","attendance"),error.message,"OK",-1,"attendance");$scope.sending_message=!1})}}
$scope.forTranslate=function(text){return $translate.instant(text,"attendance")};$scope.loadContent=function(){$scope.is_loading=!0;Attendance.customerMessages().success(function(data){$scope.messages=data.messages;$scope._scrollBottom();$scope.sentmessages.message='';$scope.sending_message=!1;$scope.is_loading=!1}).error(function(error){Dialog.alert($translate.instant("Error","attendance"),error.message,"OK",-1,"attendance");$scope.sending_message=!1;$scope.is_loading=!1})}
$scope.loadContent()});angular.module('starter').factory('Attendance',function($state,$pwaRequest){var factory={};factory.value_id=null;factory.settings={};factory.setValueId=function(valueId){factory.value_id=valueId;return factory};factory.getValueId=function(){return factory.value_id};factory.setSettings=function(settings){factory.settings=settings;return factory};factory.getSettings=function(){return factory.settings};factory.findAll=function(params){return $pwaRequest.post('/attendance/mobile_view/findall',{urlParams:{value_id:factory.value_id},data:params,cache:!1})};factory.saveStartContent=function(values){return $pwaRequest.post('attendance/mobile_view/save-start',{data:{value_id:factory.value_id,startdate:values.startdate,latitude:values.latitude,longitude:values.longitude,project_id:values.project_id,location_id:values.location_id,note:values.note},refresh:!0,cache:!1})};factory.saveEndContent=function(values){return $pwaRequest.post('attendance/mobile_view/save-end',{data:{value_id:factory.value_id,startdate:values.startdate,latitude:values.latitude,longitude:values.longitude,enddate:values.enddate,tracking_id:values.tracking_id,totaltime:values.tracking_time},refresh:!0,cache:!1})};factory.leaveSubmit=function(params){return $pwaRequest.post('/attendance/mobile_view/leave-submit',{urlParams:{value_id:factory.value_id},data:params,cache:!1,refresh:!0})};factory.findLeavesById=function(id){return $pwaRequest.post('/attendance/mobile_view/find-leaves',{urlParams:{value_id:factory.value_id,id:id},cache:!1})};factory.cancelLeaveById=function(id){return $pwaRequest.post('/attendance/mobile_view/cancel-leave',{urlParams:{value_id:factory.value_id,id:id},cache:!1})};factory.attendanceHistory=function(month,year){return $pwaRequest.post('/attendance/mobile_view/attendance-history',{urlParams:{value_id:factory.value_id,month:month,year:year},cache:!1})};factory.saveMessage=function(data){return $pwaRequest.post('attendance/mobile_view/save-message',{data:{message:data.message,value_id:this.value_id},refresh:!0,cache:!1})};factory.customerMessages=function(data){return $pwaRequest.post('attendance/mobile_view/customer-messages',{data:{value_id:this.value_id},refresh:!0,cache:!1})};return factory});Features.insertCSS(":root{--safe-area-inset-top:0;--safe-area-inset-right:0;--safe-area-inset-bottom:0;--safe-area-inset-left:0}@supports (padding-top:constant(safe-area-inset-top)){:root{--safe-area-inset-top:constant(safe-area-inset-top);--safe-area-inset-right:constant(safe-area-inset-right);--safe-area-inset-bottom:constant(safe-area-inset-bottom);--safe-area-inset-left:constant(safe-area-inset-left)}}@supports (padding-top:env(safe-area-inset-top)){:root{--safe-area-inset-top:env(safe-area-inset-top);--safe-area-inset-right:env(safe-area-inset-right);--safe-area-inset-bottom:env(safe-area-inset-bottom);--safe-area-inset-left:env(safe-area-inset-left)}}.platform-overview.platform-cordova{--safe-area-inset-top:1.5em;--safe-area-inset-right:0;--safe-area-inset-bottom:.5em;--safe-area-inset-left:0}.attendance .remove-border{border:0}.attendance .button-floating-action{position:fixed!important;top:calc(90vh - 60px)!important;right:2vw!important;border-radius:100px!important;border-width:0!important;padding:5px 12px 5px 12px!important;z-index:999!important;box-shadow:5px 5px 5px #888!important}.attendance .progress{margin:0;padding:0;width:100%;height:5px;overflow:hidden;background:#e5e5e5;border-radius:6px}.attendance .progress-bar-info{position:relative;float:left;min-width:1%;height:100%;background:cornflowerblue}.attendance .progress-bar{position:relative;float:left;min-width:1%;height:100%;background:#66bb6a}.attendance .progress-bar-red{position:relative;float:left;min-width:1%;height:100%;background:#ef5350}.attendance .progress-percent{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin:0;font-family:tahoma,arial,helvetica;font-size:12px;color:#fff}.attendance span.total-count{font-weight:700}.attendance span.remaining-count{font-weight:700;font-size:18px}.attendance span.leave-badge{right:16px}.attendance .row.leave-details-tabs{padding:0}.attendance p.leave-title{font-size:10px;opacity:.8}.attendance .leave-details-col{padding:0}.attendance p.current_date{margin-top:5%;font-size:16px;font-weight:400}.attendance .check-in-out-tabs{padding:0;font-size:20px;font-weight:600}.attendance .check-in-out-button{padding:0}.attendance .check-in-out-button{width:100%;text-transform:uppercase;min-height:auto}.attendance .check-in-out-buttons{padding:0}.attendance .check-in-out-checkin{padding:2px}.attendance .check-in-out-checkout{padding:2px}.attendance .attendance-month{font-size:10px}.attendance p.checkedin-time{opacity:.8}","attendance")